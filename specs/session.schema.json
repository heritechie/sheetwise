{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://sheetwise.dev/schemas/session.schema.json",
  "title": "SheetwiseSession",
  "description": "Formal schema defining a Sheetwise session as the single source of truth for analytics readiness.",
  "type": "object",
  "additionalProperties": false,
  "required": ["id", "state", "created_at", "analytics_model"],

  "properties": {
    "id": {
      "type": "string",
      "description": "Opaque unique identifier for the session."
    },

    "state": {
      "type": "string",
      "description": "Lifecycle state of the session.",
      "enum": ["draft", "validated", "ready"]
    },

    "created_at": {
      "type": "string",
      "description": "ISO-8601 timestamp when the session was created.",
      "format": "date-time"
    },

    "updated_at": {
      "type": "string",
      "description": "ISO-8601 timestamp of the last session update.",
      "format": "date-time"
    },

    "data_source": {
      "type": "object",
      "description": "Definition of the data source used by this session.",
      "additionalProperties": false,
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["database", "file", "url"]
        },
        "reference": {
          "type": "string",
          "description": "Connection identifier, file name, or URL reference."
        }
      }
    },

    "analytics_model": {
      "$ref": "./analytics-model.schema.json",
      "description": "Explicit analytics model driving transformation and execution."
    },

    "ai_suggestion": {
      "$ref": "./mcp-contract.schema.json",
      "description": "Last AI suggestion associated with this session. Advisory only."
    },

    "validation": {
      "type": "object",
      "description": "Validation result of the analytics model.",
      "additionalProperties": false,
      "properties": {
        "status": {
          "type": "string",
          "enum": ["valid", "valid_with_warnings", "invalid"]
        },
        "messages": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },

    "outputs": {
      "type": "array",
      "description": "Generated output artifacts after successful execution.",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["type", "location"],
        "properties": {
          "type": {
            "type": "string",
            "enum": ["csv", "excel", "sql"]
          },
          "location": {
            "type": "string",
            "description": "URI or path where the output artifact can be accessed."
          }
        }
      }
    }
  },

  "allOf": [
    {
      "if": {
        "properties": { "state": { "const": "validated" } }
      },
      "then": {
        "required": ["validation"]
      }
    },
    {
      "if": {
        "properties": { "state": { "const": "ready" } }
      },
      "then": {
        "required": ["outputs"]
      }
    }
  ]
}
